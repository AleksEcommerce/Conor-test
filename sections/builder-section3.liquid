<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet"> 
{{ 'builder-layout.css' | asset_url | stylesheet_tag }}
{{ 'builder-products.css' | asset_url | stylesheet_tag }}
{{ 'builder-animation.css' | asset_url | stylesheet_tag }}
{{ 'builder-steps.css' | asset_url | stylesheet_tag }}

{{ 'builder-tabs.css' | asset_url | stylesheet_tag }}
 
<link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
<script src="https://unpkg.com/swiper/swiper-bundle.min.js" defer></script>

{% comment %}  {% endcomment %}
{% comment %} <script src="https://cdn.jsdelivr.net/npm/@shopify/draggable@1.0.0-beta.8/lib/draggable.bundle.legacy.js" defer></script> {% endcomment %}
<script src="{{ 'sortable.js' | asset_url }}" defer></script>
{% comment %}  {% endcomment %}

<script src="{{ 'builder-script.js' | asset_url }}" defer></script>
<script src="{{ 'builder-tabs.js' | asset_url }}" defer></script>

<section id='builder-container' class='l-builder m-step-1'>
  <article class="l-builder-picture">
    <div class="b-chain" id="pendant-builder-container">
      <div class="swiper-container">
        <div class="swiper-wrapper">
          {% for product in section.settings.select_first_product %}
            {% assign product = all_products[product] %}
            <div class="swiper-slide" data-product-active-id="{{ product.variants.first.id }}">
              <img src="{{ product.metafields.custom.charm_builder_image | img_url: 'master' }}" alt="{{ product.title }}">
              <span class="b-chain-text">
                <span class="b-chain-text_title">{{ product.title }}</span>
                <span class="b-chain-text_subtitle">{{ product.variants.first.price | money }}</span>
              </span>
            </div>
          {% endfor %}
        </div>
        <div id="charms_presentation" class="b-charms_presentation"></div>

        <div class="swiper-button-next b-chain_nav-btn m-next">
          
        </div>
        <div class="swiper-button-prev b-chain_nav-btn m-prev">
          
        </div>
        {% comment %} <div class="swiper-pagination"></div> {% endcomment %}
      </div>
      <div id='b-notice' class="b-charms-notice hidden">Maximum number of pendants added</div>
    </div>
    {% comment %} <button id="b-select_btn" class="b-select" data-product-active="">SELECT</button> {% endcomment %}
  </article>

  <article class="l-builder-cart">
    <div class="b-builder__cart">
      <ul id="builder-cart-list" class="b-builder__cart-list">
      </ul>
      <div class="b-builder__cart-total">
        <span class="b-builder__cart-total_text">
          Subtotal: <span id="builder-cart-total-items"></span>
        </span>
        <span id="builder-cart-total" class="b-builder__cart-total_price">$0.00</span>
      </div>
    </div>
    <span id="builder-cart-checkout" class="b-builder__cart-checkout">ADD CHARM BUILDER TO CART</span>
  </article>

  <article class="l-builder-tabs">
    <div id="builder-tabs" class="b-tabs">
      <div class="b-tabs-nav">
        <div class="b-tabs-nav-item m-active" data-tab="chains">Chains</div>
        <div class="b-tabs-nav-item" data-tab="charms">Charms</div>
        <div class="b-tabs-nav-item" data-tab="spacers">Spacers</div>
        <div class="b-tabs-nav-indicator"></div>
      </div>
      <div class="b-tabs-content-wrapper">
        <div class="b-tabs-content">
          <div class="b-tabs-content-item m-active" data-tab="chains">
            <div class="b-tabs-content-item__list swiper-pagination-custom">
              {% for product in section.settings.select_first_product %}
                {% assign product = all_products[product] %}
                <div class="b-tabs-content-item__list-item swiper-pagination-thumb" data-product-id="{{ product.variants.first.id }}">
                  <figure class="b-tabs-content-item__figure">
                    <img 
                      src="{{ product.metafields.custom.charm_builder_image | img_url: 'medium' }}" 
                      alt="{{ product.title }}"
                      class="b-tabs-content-item__list-item_img"
                    >
                  </figure>
                  <div class="b-tabs-content-item__desc"> 
                    <span class="b-tabs-content-item__list-item_title">{{ product.title }}</span>
                    <span class="b-tabs-content-item__list-item_subtitle">{{ product.variants.first.price | money }}</span>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
          <div class="b-tabs-content-item" data-tab="charms">
            <div class="b-tabs-content-item__list b-charm__list m-charms">
              {% for product in section.settings.select_second_product %}
                {% assign product = all_products[product] %}
                <div class="b-tabs-content-item__list-item charm-checkbox" 
                  data-product-id="{{ product.variants.first.id }}"
                  data-charm="{{ product.metafields.custom.charm_builder_image | image_url }}" 
                >
                  <figure class="b-tabs-content-item__figure">
                    <img 
                      src="{{ product.metafields.custom.charm_builder_image | img_url: 'medium' }}" 
                      alt="{{ product.title }}"
                      class="b-tabs-content-item__list-item_img"
                    >
                  </figure>
                  <div class="b-tabs-content-item__desc"> 
                    <span class="b-tabs-content-item__list-item_title">{{ product.title }}</span>
                    <span class="b-tabs-content-item__list-item_subtitle">{{ product.variants.first.price | money }}</span>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
          <div class="b-tabs-content-item" data-tab="spacers">
            <div class="b-tabs-content-item__list b-charm__list m-spacer">
              {% for product in section.settings.select_third_product %}
                {% assign product = all_products[product] %}
                <div class="b-tabs-content-item__list-item spacer-checkbox" 
                  data-product-id="{{ product.variants.first.id }}"
                  data-charm="{{ product.metafields.custom.charm_builder_image | image_url }}" 
                >
                  <figure class="b-tabs-content-item__figure">
                    <img 
                      src="{{ product.metafields.custom.charm_builder_image | img_url: 'medium' }}" 
                      alt="{{ product.title }}"
                      class="b-tabs-content-item__list-item_img"
                    >
                  </figure>
                  <div class="b-tabs-content-item__desc"> 
                    <span class="b-tabs-content-item__list-item_title">{{ product.title }}</span>
                    <span class="b-tabs-content-item__list-item_subtitle">{{ product.variants.first.price | money }}</span>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </article>  


  
</section>
<article class="l-builder-charms">
  <div class="row-container">
    <div class="row-item">1</div> 

    {% comment %} <div class="row-item">8</div> {% endcomment %}
</div>
<button class='row-container_add-item'> Add to cart </button>

<style>
  .l-builder-charms {
    height: 500px;

  }


  .row-container {
    display: flex;
    justify-content: center;
    height: 50px;
    width: 300px;
    position: relative;
    border: 1px solid #ccc;
    margin: 50px auto 0;
}

.row-item {
    width: 50px;
    height: 50px;
    background-color: #4CAF50;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: grab;
    transition: all 0.3s ease; /* Плавное перемещение */
    position: absolute;
    left: 50%;
    top: 50%;
    margin: 0 0 0 -25px; 
}

.row-container .row-item.m-1-line {
  margin-top: -25px;
}
.row-container .row-item.m-1-line.m-l-col {
  transform: translateX(-30px);
}
.row-container .row-item.m-1-line.m-r-col {
  transform: translateX(30px);
}


.row-container .row-item.m-2-line {
  margin-top: -50px;
}
.row-container .row-item.m-2-line.m-l-col {
  transform: translateX(-60px);
}
.row-container .row-item.m-2-line.m-r-col {
  transform: translateX(60px);
}


.row-container .row-item.m-3-line {
  margin-top: -75px;
}
.row-container .row-item.m-3-line.m-l-col {
  transform: translateX(-90px);
}
.row-container .row-item.m-3-line.m-r-col {
  transform: translateX(90px);
}


.row-container.m-even .row-item.m-center.m-l-col {
  margin-top: 0;
  transform: translateX(-15px);
}
.row-container.m-even .row-item.m-center.m-r-col {
  margin-top: 0;
  transform: translateX(15px);
}
.row-container.m-odd .row-item.m-center {
  margin-top: 0;
  transform: translateX(0);
}

.sortable-ghost {
  opacity: 0.4; /* Полупрозрачный элемент при перетаскивании */
}

.sortable-swap-highlight {
  border: 2px dashed #FF6347; /* Показать границу при наведении */
}
</style>
</article>


<script>
  document.addEventListener('DOMContentLoaded', function() {
   ///////////////////////////////////////////////////////////////////////////
   /// Первій пример
  const container = document.querySelector('.row-container');
  const addItemButton = document.querySelector('.row-container_add-item');

  addItemButton.addEventListener('click', function() {
  const newItem = document.createElement('div');
  newItem.classList.add('row-item');
  newItem.textContent = container.querySelectorAll('.row-item').length + 1;
  container.appendChild(newItem);
    updateClasses(); // Обновляем классы после добавления
  });

  function updateClasses() {
    let allItems = container.querySelectorAll('.row-item'); // Обновляем список элементов
    console.log(allItems);

    // Сначала удаляем все добавленные ранее классы
    allItems.forEach(item => {
        item.classList.remove('m-3-line', 'm-2-line', 'm-1-line', 'm-center', 'm-l-col', 'm-r-col');
    });

    // Определяем четное или нечетное количество элементов
    if (allItems.length % 2 !== 0) {
        container.classList.remove('m-even');
        container.classList.add('m-odd');

        // Устанавливаем классы в зависимости от количества элементов
        if (allItems.length === 7) {
            allItems[0].classList.add('m-3-line', 'm-l-col');
            allItems[6].classList.add('m-3-line', 'm-r-col');

            allItems[1].classList.add('m-2-line', 'm-l-col');
            allItems[5].classList.add('m-2-line', 'm-r-col');

            allItems[2].classList.add('m-1-line', 'm-l-col');
            allItems[4].classList.add('m-1-line', 'm-r-col');

            allItems[3].classList.add('m-center');
        } else if (allItems.length === 5) {
            allItems[0].classList.add('m-2-line', 'm-l-col');
            allItems[4].classList.add('m-2-line', 'm-r-col');

            allItems[1].classList.add('m-1-line', 'm-l-col');
            allItems[3].classList.add('m-1-line', 'm-r-col');

            allItems[2].classList.add('m-center');
        } else if (allItems.length === 3) {
            allItems[0].classList.add('m-1-line', 'm-l-col');
            allItems[2].classList.add('m-1-line', 'm-r-col');

            allItems[1].classList.add('m-center');
        } else if (allItems.length === 1) {
            allItems[0].classList.add('m-center');
        }
    } else {
        container.classList.remove('m-odd');
        container.classList.add('m-even');

        if (allItems.length === 8) {
            allItems[0].classList.add('m-3-line', 'm-l-col');
            allItems[7].classList.add('m-3-line', 'm-r-col');

            allItems[1].classList.add('m-2-line', 'm-l-col');
            allItems[6].classList.add('m-2-line', 'm-r-col');

            allItems[2].classList.add('m-1-line', 'm-l-col');
            allItems[5].classList.add('m-1-line', 'm-r-col');

            allItems[3].classList.add('m-center', 'm-l-col');
            allItems[4].classList.add('m-center', 'm-r-col');
        } else if (allItems.length === 6) {
            allItems[0].classList.add('m-2-line', 'm-l-col');
            allItems[5].classList.add('m-2-line', 'm-r-col');

            allItems[1].classList.add('m-1-line', 'm-l-col');
            allItems[4].classList.add('m-1-line', 'm-r-col');

            allItems[2].classList.add('m-center', 'm-l-col');
            allItems[3].classList.add('m-center', 'm-r-col');
        } else if (allItems.length === 4) {
            allItems[0].classList.add('m-1-line', 'm-l-col');
            allItems[3].classList.add('m-1-line', 'm-r-col');

            allItems[1].classList.add('m-center', 'm-l-col');
            allItems[2].classList.add('m-center', 'm-r-col');
        } else if (allItems.length === 2) {
            allItems[0].classList.add('m-center', 'm-l-col');
            allItems[1].classList.add('m-center', 'm-r-col');
        }
      }
  }

  const sortable = new Sortable(container, {
      animation: 150, // Анимация перемещения
      ghostClass: 'sortable-ghost', // Класс для элемента-призрака
      swap: true, // Включить режим swap
      swapClass: 'sortable-swap-highlight', // Класс для выделения при наведении
      swapThreshold: 0.65, // Порог срабатывания обмена
      onEnd: function () {
          // Опционально: действия после окончания перетаскивания
          console.log('Позиции обновлены');
          updateClasses(); // Обновляем классы после изменения порядка
      },
  });

  // Пример функции удаления элемента
  container.addEventListener('click', function (event) {
      if (event.target.classList.contains('row-item')) {
          const itemToRemove = event.target;

          // Удаляем элемент
          itemToRemove.remove();
          updateClasses(); // Обновляем классы после удаления
          console.log(`Элемент с номером ${itemToRemove.textContent} удален`);
      }
  });

  updateClasses();


    ///////////////////////////////////////////////////////////////////////////////
    const paginationThumbs = document.querySelectorAll('.swiper-pagination-thumb');
    const swiper = new Swiper('.swiper-container', {
      loop: true,
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      on: {
        slideChange: function() {
            updatePagination(this.activeIndex);
        },
      },
      slidesPerView: 1,
    });

    paginationThumbs.forEach((thumb, index) => {
      thumb.addEventListener('click', function() {
          swiper.slideToLoop(index); // Используем slideToLoop для правильного перехода
      });
  });

  function updatePagination(activeIndex) {
    paginationThumbs.forEach((thumb, index) => {
        thumb.classList.remove('active');
        if (index === activeIndex) {
            thumb.classList.add('active');
        }
    });
}
    updatePagination(swiper.activeIndex);

    var selectedProductsFirst = [
      {% for product in section.settings.select_first_product %}
        {
            "id": "{{ product.variants.first.id }}",
            "title": "{{ product.title | escape }}",
            "price": {{ product.variants.first.price | divided_by: 100 }},
            "image": "{{ product.featured_image | img_url: 'small' }}",
            "variant_title": "{{ product.variants.first.title | escape }}",
            "qty": 1
        }{% if forloop.last == false %},{% endif %}
      {% endfor %}
    ];

    var selectedProductsSecond = [
      {% for product in section.settings.select_second_product %}
        {
            "id": "{{ product.variants.first.id }}",
            "title": "{{ product.title | escape }}",
            "price": {{ product.variants.first.price | divided_by: 100 }},
            "image": "{{ product.featured_image | img_url: 'small' }}",
            "variant_title": "{{ product.variants.first.title | escape }}",
            "qty": 1
        }{% if forloop.last == false %},{% endif %}
      {% endfor %}
    ];

    var selectedProductsThird = [
      {% for product in section.settings.select_third_product %}
        {
            "id": "{{ product.variants.first.id }}",
            "title": "{{ product.title | escape }}",
            "price": {{ product.variants.first.price | divided_by: 100 }},
            "image": "{{ product.featured_image | img_url: 'small' }}",
            "variant_title": "{{ product.variants.first.title | escape }}",
            "qty": 1
        }{% if forloop.last == false %},{% endif %}
      {% endfor %}
    ];

    function setLocalStorageData(productsArray, name) {
      const storageKey = `builder.${name}`;
      const existingData = JSON.parse(localStorage.getItem(storageKey)) || [];
      const updatedData = [...existingData, ...productsArray];
      const uniqueData = updatedData.reduce((acc, current) => {
        if (!acc.some(product => product.id === current.id)) {
          acc.push(current);
        }
        return acc;
      }, []);
      localStorage.setItem(storageKey, JSON.stringify(uniqueData));
    }
    localStorage.clear();
    const activeChain = document.querySelector('.swiper-slide-active').getAttribute('data-product-active-id');
    localStorage.setItem('builder.activeChain', JSON.stringify(activeChain));
    setLocalStorageData([...selectedProductsFirst, ...selectedProductsSecond, ...selectedProductsThird], 'selectedProducts');
  });
</script>

{% schema %}
{
  "name": "Pendant Builder 3", 
  "settings": [
    {
      "type": "header",
      "content": "Step 1: Select a Chain"
    },
    {
      "type": "product_list",
      "id": "select_first_product",
      "label": "Select Products",
      "info": "Choose the products to display in the carousel.",
      "limit": 10
    },
    {
      "type": "text",
      "id": "step_title_1",
      "label": "Step 1 Title",
      "default": "Lorem Ipsum"
    },
    {
      "type": "textarea",
      "id": "step_subtitle_1",
      "label": "Step 1 Subtitle",
      "default": "Lorem Ipsum is simply dummy text of the printing and typesetting industry."
    },
    {
      "type": "header",
      "content": "Step 2: Choose Your Charms"
    },
    {
      "type": "product_list",
      "id": "select_second_product",
      "label": "Select Products",
      "info": "Choose the products to display in the scrollbar.",
      "limit": 15
    },
    {
      "type": "text",
      "id": "step_title_2",
      "label": "Step 2 Title",
      "default": "Lorem Ipsum"
    },
    {
      "type": "textarea",
      "id": "step_subtitle_2",
      "label": "Step 2 Subtitle",
      "default": "Lorem Ipsum is simply dummy text of the printing and typesetting industry."
    },
    {
      "type": "header",
      "content": "Step 3: Add Charm Spacers"
    },
    {
      "type": "product_list",
      "id": "select_third_product",
      "label": "Select Products",
      "info": "Choose the products to display in the scrollbar.",
      "limit": 15
    },
    {
      "type": "text",
      "id": "step_title_3",
      "label": "Step 3 Title",
      "default": "Lorem Ipsum"
    },
    {
      "type": "textarea",
      "id": "step_subtitle_3",
      "label": "Step 3 Subtitle",
      "default": "Lorem Ipsum is simply dummy text of the printing and typesetting industry."
    }
  ],
  "presets": [
    {
      "name": "Pendant Builder 3",
      "category": "Custom"
    }
  ]
}
{% endschema %}