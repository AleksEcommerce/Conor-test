<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet"> 
{{ 'builder-layout.css' | asset_url | stylesheet_tag }}
{{ 'builder-products.css' | asset_url | stylesheet_tag }}
{{ 'builder-animation.css' | asset_url | stylesheet_tag }}
{{ 'builder-steps.css' | asset_url | stylesheet_tag }}
 
<!-- Подключение стилей и скриптов Swiper -->
<link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
<script src="https://unpkg.com/swiper/swiper-bundle.min.js" defer></script>

<script src="{{ 'builder-script.js' | asset_url }}" defer></script>

<section id='builder-container' class='l-builder m-step-1'>
  <article class="l-builder-steps">
    <div class="b-steps">
      <div class="b-steps-nav">
        <div class="b-steps-nav-item m-back">
          <span class="b-steps-nav-item__link" id="builder-step-prev">
            <i class="icon-chevron-left"></i>
            <span>Back</span>
          </span>
        </div>
        <div class="b-steps-nav-item m-next">
          <span class="b-steps-nav-item__link" id="builder-step-next">
            <span>Next</span>
            <i class="icon-chevron-right"></i>
          </span>
        </div>
      </div>
      <div id="builder-steps" class="b-steps-list">
        <div class="b-steps-item" data-item="1">1</div>
        <div class="b-steps-item" data-item="2">2</div>
        <div class="b-steps-item" data-item="3">3</div>
      </div>
      <div class="b-steps-desc">
        <h2 class="b-steps-desc-title">
          <span class="b-steps-desc-title_text m-step-1">{{ section.settings.step_title_1 }}</span>
          <span class="b-steps-desc-title_text m-step-2">{{ section.settings.step_title_2 }}</span>
          <span class="b-steps-desc-title_text m-step-3">{{ section.settings.step_title_3 }}</span>
        </h2>
        <p class="b-steps-desc-subtitle">
          <span class="b-steps-desc-subtitle_text m-step-1">{{ section.settings.step_subtitle_1 }}</span>
          <span class="b-steps-desc-subtitle_text m-step-2">{{ section.settings.step_subtitle_2 }}</span>
          <span class="b-steps-desc-subtitle_text m-step-3">{{ section.settings.step_subtitle_3 }}</span>
        </p>
      </div>
    </div>
  </article>

  <article class="l-builder-picture">
    <div class="b-chain" id="pendant-builder-container">
      <!-- Swiper контейнер -->
      <div class="swiper-container">
        <div class="swiper-wrapper">
          {% for product in section.settings.select_first_product %}
            {% assign product = all_products[product] %}
            {% assign product_price = product.price | divided_by: 100 %}
            <div class="swiper-slide" data-product-active-id="{{ product.variants.first.id }}">
              <img src="{{ product.metafields.custom.charm_builder_image | img_url: 'master' }}" alt="{{ product.title }}">
              <span class="b-chain-text">
                <span class="b-chain-text_title">{{ product.title }}</span>
                <span class="b-chain-text_subtitle"> Lorem Ipsum Color</span>
              </span>
            </div>
          {% endfor %}
        </div>
        <div class="b-charms_presentation"></div>
        <!-- Навигационные кнопки -->
        <div class="swiper-button-next b-chain_nav-btn m-next">
          
        </div>
        <div class="swiper-button-prev b-chain_nav-btn m-prev">
          
        </div>
        <!-- Пагинация -->
        <div class="swiper-pagination"></div>
      </div>
      <div id='b-notice' class="b-charms-notice hidden">Maximum number of pendants added</div>
    </div>
    <button id="b-select_btn" class="b-select" data-product-active="">SELECT</button>
    
  </article>

  <article class="l-builder-charms">
    <div class="b-builder__cart">
      <div class="b-builder__cart-title">
        <h2 class="b-builder__cart-title_text"></h2>
        <p class="b-builder__cart-title_subtitle"></p>
      </div>
      <ul class="b-builder__cart-list">
        <li class="b-builder__cart-list_item"><div>Test Decription</div></li>
        <li class="b-builder__cart-list_item"><div>Test Decription</div></li>
        <li class="b-builder__cart-list_item"><div>Test Decription</div></li>
        <li class="b-builder__cart-list_item"><div>Test Decription</div></li>
      </ul>
      <div class="b-builder__cart-total">
        <span class="b-builder__cart-total_text">
          Subtotal: <span id="builder-cart-total-items"></span>
        </span>
        <span id="builder-cart-total" class="b-builder__cart-total_price">$0.00</span>
      </div>
    </div>
    <div class="b-charm__list">
      {% for product in section.settings.select_second_product %}
        {% assign product = all_products[product] %}
        <div class="b-charm__list-item">
          <label for="charm-{{ forloop.index }}">
            <input 
              type="checkbox" 
              id="charm-{{ forloop.index }}" 
              name="charm-{{ forloop.index }}" 
              class="charm-checkbox" 
              data-charm="{{ product.metafields.custom.charm_builder_image | image_url }}"
              data-product-id="{{ product.variants.first.id }}"
            >
            <img class="b-charm__list-item_img" src="{{ product.metafields.custom.charm_builder_image | img_url: 'medium' }}" alt="{{ product.title }}">
          </label>
        </div>
      {% endfor %}
    </div>
  </article>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Инициализация Swiper
    const swiper = new Swiper('.swiper-container', {
      loop: true,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      slidesPerView: 1,
    });

    var selectedProductsFirst = [
      {% for product in section.settings.select_first_product %}
        {
            "id": "{{ product.variants.first.id }}",
            "title": "{{ product.title | escape }}",
            "price": {{ product.variants.first.price | divided_by: 100 }},
            "image": "{{ product.featured_image | img_url: 'small' }}",
            "variant_title": "{{ product.variants.first.title | escape }}"
        }{% if forloop.last == false %},{% endif %}
      {% endfor %}
    ];

    var selectedProductsSecond = [
      {% for product in section.settings.select_second_product %}
        {
            "id": "{{ product.variants.first.id }}",
            "title": "{{ product.title | escape }}",
            "price": {{ product.variants.first.price | divided_by: 100 }},
            "image": "{{ product.featured_image | img_url: 'small' }}",
            "variant_title": "{{ product.variants.first.title | escape }}"
        }{% if forloop.last == false %},{% endif %}
      {% endfor %}
    ];

    // Обновленная функция для объединения и записи данных в localStorage
    function setLocalStorageData(productsArray, name) {
      const storageKey = `builder.${name}`;
      // Извлекаем существующие данные или инициализируем пустым массивом
      const existingData = JSON.parse(localStorage.getItem(storageKey)) || [];

      // Объединяем существующие данные с новыми продуктами
      const updatedData = [...existingData, ...productsArray];

      // Удаляем дубликаты на основе id продукта
      const uniqueData = updatedData.reduce((acc, current) => {
        if (!acc.some(product => product.id === current.id)) {
          acc.push(current);
        }
        return acc;
      }, []);

      // Сохраняем объединенный массив без дубликатов в localStorage
      localStorage.setItem(storageKey, JSON.stringify(uniqueData));
    }

    setLocalStorageData([...selectedProductsFirst, ...selectedProductsSecond], 'selectedProducts');
  });
</script>

{% schema %}
{
  "name": "Pendant Builder 3",
  "settings": [
    {
      "type": "header",
      "content": "Step 1: Select a Chain"
    },
    {
      "type": "product_list",
      "id": "select_first_product",
      "label": "Select Products",
      "info": "Choose the products to display in the carousel.",
      "limit": 10
    },
    {
      "type": "text",
      "id": "step_title_1",
      "label": "Step 1 Title",
      "default": "Lorem Ipsum"
    },
    {
      "type": "textarea",
      "id": "step_subtitle_1",
      "label": "Step 1 Subtitle",
      "default": "Lorem Ipsum is simply dummy text of the printing and typesetting industry."
    },
    {
      "type": "header",
      "content": "Step 2: Choose Your Charms"
    },
    {
      "type": "product_list",
      "id": "select_second_product",
      "label": "Select Products",
      "info": "Choose the products to display in the scrollbar.",
      "limit": 15
    },
    {
      "type": "text",
      "id": "step_title_2",
      "label": "Step 2 Title",
      "default": "Lorem Ipsum"
    },
    {
      "type": "textarea",
      "id": "step_subtitle_2",
      "label": "Step 2 Subtitle",
      "default": "Lorem Ipsum is simply dummy text of the printing and typesetting industry."
    },
    {
      "type": "header",
      "content": "Step 3: Add Charm Spacers"
    },
    {
      "type": "text",
      "id": "step_title_3",
      "label": "Step 3 Title",
      "default": "Lorem Ipsum"
    },
    {
      "type": "textarea",
      "id": "step_subtitle_3",
      "label": "Step 3 Subtitle",
      "default": "Lorem Ipsum is simply dummy text of the printing and typesetting industry."
    }
  ],
  "presets": [
    {
      "name": "Pendant Builder 3",
      "category": "Custom"
    }
  ]
}
{% endschema %}